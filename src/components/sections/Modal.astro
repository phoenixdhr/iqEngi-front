---
import ForgotPassword from '@components/molecules/login/ForgotPassword.astro';
import LoginCreatePassword from '@components/molecules/login/LoginCreatePassword.astro';
import LoginGoogle from '@components/molecules/login/LoginGoogle.astro';
import LoginModal from '@components/molecules/login/LoginModal.astro';
import LoginPassword from '@components/molecules/login/LoginPassword.astro';
import LoginCreatePasswordName from '@components/molecules/login/LoginCreatePasswordName.astro';
import Bienvenida from '@components/molecules/login/Bienvenida.astro';
---

<div
    id="login-modal"
    class="hidden fixed inset-0 items-center justify-center z-50"
    style="background-color: var(--color-overlay-bg);"
>
    <!-- Caja interna del modal que contiene el formulario de inicio de sesión -->
    <div
        id="astro-login-box"
        class="p-8 rounded-3xl w-11/12 max-w-md h-auto min-h-[500px] relative shadow-2xl flex flex-col"
        style="background-color: var(--color-bg); color: var(--color-text);"
    >
        <!-- Botón de cierre -->
        <button
            id="btnClose"
            type="button"
            class="absolute top-4 right-4 hover:opacity-80 text-xl"
            style="color: var(--color-text-muted);"
        >
            ✖
        </button>
        <!-- Botón de regresar (se muestra solo si se proporciona onBack) -->

        <button
            id="btnBack"
            type="button"
            class="hidden absolute top-4 left-4 hover:opacity-80 text-2xl mr-4"
            style="color: var(--color-text-muted);"
        >
            ←
        </button>

        <!-- Logo de IQ-ENGI -->
        <div class="flex justify-center items-center space-x-2 mt-4 mb-2">
            <img
                class="h-8 lg:h-10 w-auto"
                src="/favicon.svg"
                alt="IqEngi"
            />
            <span
                class="bg-clip-text text-transparent font-bold text-2xl lg:text-3xl"
                style="background: var(--gradient-button-primary); -webkit-background-clip: text;"
            >
                IQ-ENGI
            </span>
        </div>

        <!-- Contenido específico del modal -->

        <div id="loginModalDiv"><LoginModal /></div>
        <div id="loginCreatePasswordDiv" class="hidden">
            <LoginCreatePassword />
            <!-- <CreatePassword client:only="true" /> -->
        </div>
        <div id="loginGoogleDiv" class="hidden"><LoginGoogle /></div>
        <div id="loginPasswordDiv" class="hidden"><LoginPassword /></div>
        <div id="loginCreatePasswordNameDiv" class="hidden">
            <LoginCreatePasswordName />
        </div>
        <div id="forgotPasswordDiv" class="hidden"><ForgotPassword /></div>
        <div id="bienvenidaDiv" class="hidden">
            <Bienvenida />
        </div>
    </div>
</div>
<script>
    import {
        showElement,
        hideElement,
        clearFields,
    } from '@services/closeOpenLogin';

    function closeModal() {
        showElement('loginModalDiv');
        hideElement('loginCreatePasswordDiv');
        hideElement('loginGoogleDiv');
        hideElement('loginPasswordDiv');
        hideElement('forgotPasswordDiv');
        hideElement('loginCreatePasswordNameDiv');
        hideElement('btnBack');
        hideElement('bienvenidaDiv');

        clearFields([
            'emailInput',
            'spanEmail',
            'emailGoogleSpan',
            'passwordInput',
            'confirmPasswordInput',
            'passwordLoginInput',
            'firstNameInput',
            'lastNameInput',
            'firstNameWelcomeSpan',
            'errorIncorrectPasswordSpan',
        ]);
    }

    function setupModalListeners() {
        const btnBack = document.getElementById('btnBack');
        btnBack &&
            btnBack.addEventListener('click', () => {
                const btnCheckPassword = document.getElementById(
                    'btnCheckPassword',
                ) as HTMLButtonElement;

                const btnCrearCuenta = document.getElementById(
                    'btnCrearCuenta',
                ) as HTMLButtonElement;

                if (btnCheckPassword) {
                    btnCheckPassword.classList.add(
                        'opacity-50',
                        'cursor-not-allowed',
                    );
                }
                if (btnCrearCuenta) {
                    btnCrearCuenta.classList.add(
                        'opacity-50',
                        'cursor-not-allowed',
                    );
                }

                closeModal();
            });

        const btnClose = document.getElementById('btnClose');
        btnClose &&
            btnClose.addEventListener('click', () => {
                closeModal();
                hideElement('login-modal');
            });

        window.addEventListener('listener-login-modal', () => {
            showElement('login-modal');
            showElement('loginModalDiv');
        });
    }

    // Setup listeners on initial page load
    setupModalListeners();

    // Re-setup listeners after Astro view transitions
    document.addEventListener('astro:page-load', setupModalListeners);
</script>
