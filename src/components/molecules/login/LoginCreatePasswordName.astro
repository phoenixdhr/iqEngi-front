---
/* Si estás usando Astro, aquí podrías importar algo si fuera necesario,
   por ejemplo variables de entorno o configuración del sitio.
   En caso contrario, puedes omitir esta sección. */
---

<!-- Modal para "Crear una contraseña" --><!-- Título e indicación -->
<div id="div-create-password" class="text-center">
    <h2 class="text-xl font-semibold mb-1">Finalmente, ¿cómo te llamas?</h2>

    <p class="text-base mb-4" style="color: var(--color-text-muted);">
        Asegúrate de escribirlo como debe aparecer en tus certificados.
    </p>
</div>

<!-- Formulario para ingresar y confirmar contraseña -->
<div
    id="createPasswordNameForm"
    class="relative flex flex-col justify-center mt-7"
>
    <form class="space-y-6" id="loginPasswordNameForm">
        <input
            id="firstNameInput"
            type="text"
            placeholder="Nombres"
            onblur="this.value = this.value.trim()"
            required
            class="w-full h-12 px-4 border focus:outline-none focus:ring-2 rounded-full text-center placeholder:text-center"
            style="background-color: var(--color-bg); border-color: var(--color-border); color: var(--color-text); --tw-ring-color: var(--color-success);"
        />

        <input
            id="lastNameInput"
            type="text"
            placeholder="Apellidos"
            onblur="this.value = this.value.trim()"
            required
            class="w-full h-12 px-4 border focus:outline-none focus:ring-2 rounded-full text-center placeholder:text-center"
            style="background-color: var(--color-bg); border-color: var(--color-border); color: var(--color-text); --tw-ring-color: var(--color-success);"
        />

        <button
            id="btnCrearCuenta"
            disabled
            type="submit"
            class="w-full h-12 text-white font-medium text-base rounded-full opacity-50 cursor-not-allowed focus:ring-4"
            style="background: var(--gradient-button-primary);"
        >
            Crear Cuenta
        </button>
    </form>
</div>

<!-- Listener para mostrar el modal cuando se dispare el evento "open-login-password-modal" -->

<script>
    import { clientGql } from '@graphql-astro/apolloClient.ts';
    import {
        SignupDocument,
        type Usuario,
    } from '@graphql-astro/generated/graphql';

    import { showElement, hideElement } from '@services/closeOpenLogin';

    function setupCreatePasswordNameListeners() {
        const emailInput = document.getElementById(
            'emailInput',
        ) as HTMLInputElement;

        // Aquí puedes agregar cualquier script adicional que necesites
        // Por ejemplo, para manejar el envío del formulario o la validación de campos
        const loginPasswordNameForm = document.getElementById(
            'loginPasswordNameForm',
        ) as HTMLFormElement;

        const passwordInput = document.getElementById(
            'passwordInput',
        ) as HTMLInputElement;
        const confirmPasswordInput = document.getElementById(
            'confirmPasswordInput',
        ) as HTMLInputElement;

        const firstNameInput = document.getElementById(
            'firstNameInput',
        ) as HTMLInputElement;
        const lastNameInput = document.getElementById(
            'lastNameInput',
        ) as HTMLInputElement;

        const btnCrearCuenta = document.getElementById(
            'btnCrearCuenta',
        ) as HTMLButtonElement;

        if (!loginPasswordNameForm || !firstNameInput || !lastNameInput) return;

        // Función que actualiza el estado del botón según el contenido de los campos
        function updateButtonState() {
            const firstNameValue = firstNameInput.value.trim();
            const lastNameValue = lastNameInput.value.trim();
            const isValid = firstNameValue !== '' && lastNameValue !== '';

            btnCrearCuenta.disabled = !isValid;

            if (isValid) {
                btnCrearCuenta.classList.remove(
                    'opacity-50',
                    'cursor-not-allowed',
                );
                btnCrearCuenta.classList.add('cursor-pointer');
                btnCrearCuenta.classList.toggle('hover:scale-105', isValid);
                btnCrearCuenta.classList.toggle(
                    'transition-transform',
                    isValid,
                );
            } else {
                btnCrearCuenta.classList.add(
                    'opacity-50',
                    'cursor-not-allowed',
                );
                btnCrearCuenta.classList.remove('cursor-pointer');
            }
        }

        // Ejecutar inmediatamente
        updateButtonState();

        // Eliminar listeners existentes mediante clonado del formulario
        // Esto previene duplicación de eventos cuando Astro reconstruye el DOM en view transitions
        const newForm = loginPasswordNameForm.cloneNode(
            true,
        ) as HTMLFormElement;
        loginPasswordNameForm.parentNode?.replaceChild(
            newForm,
            loginPasswordNameForm,
        );

        // Obtener referencias frescas de los elementos después del clonado
        const newFirstNameInput = document.getElementById(
            'firstNameInput',
        ) as HTMLInputElement;
        const newLastNameInput = document.getElementById(
            'lastNameInput',
        ) as HTMLInputElement;
        const newBtnCrearCuenta = document.getElementById(
            'btnCrearCuenta',
        ) as HTMLButtonElement;

        // Redefinir función de actualización del botón con las nuevas referencias del DOM
        function updateButtonStateNew() {
            const firstNameValue = newFirstNameInput.value.trim();
            const lastNameValue = newLastNameInput.value.trim();
            const isValid = firstNameValue !== '' && lastNameValue !== '';

            newBtnCrearCuenta.disabled = !isValid;

            if (isValid) {
                newBtnCrearCuenta.classList.remove(
                    'opacity-50',
                    'cursor-not-allowed',
                );
                newBtnCrearCuenta.classList.add('cursor-pointer');
                newBtnCrearCuenta.classList.toggle('hover:scale-105', isValid);
                newBtnCrearCuenta.classList.toggle(
                    'transition-transform',
                    isValid,
                );
            } else {
                newBtnCrearCuenta.classList.add(
                    'opacity-50',
                    'cursor-not-allowed',
                );
                newBtnCrearCuenta.classList.remove('cursor-pointer');
            }
        }

        // Listener para actualizar el estado del botón al ingresar texto
        newForm.addEventListener('input', updateButtonStateNew);

        newForm.addEventListener('submit', async function (event) {
            event.preventDefault();

            const passwordInputCurrent = document.getElementById(
                'passwordInput',
            ) as HTMLInputElement;
            const confirmPasswordInputCurrent = document.getElementById(
                'confirmPasswordInput',
            ) as HTMLInputElement;
            const emailInputCurrent = document.getElementById(
                'emailInput',
            ) as HTMLInputElement;

            const password = passwordInputCurrent?.value.trim() || '';
            const confirmPassword =
                confirmPasswordInputCurrent?.value.trim() || '';
            const firstName = newFirstNameInput.value.trim();
            const lastName = newLastNameInput.value.trim();

            const email = emailInputCurrent?.value.trim() || '';
            try {
                if (
                    password &&
                    confirmPassword &&
                    password === confirmPassword
                ) {
                    const { data } = await clientGql.mutate({
                        mutation: SignupDocument,
                        variables: {
                            createUsuarioInput: {
                                email: email,
                                password: password,
                                firstName: firstName,
                                lastName: lastName,
                            },
                        },
                    });

                    const usuario: Usuario = data.signup;
                    if (passwordInputCurrent) passwordInputCurrent.value = '';
                    if (confirmPasswordInputCurrent)
                        confirmPasswordInputCurrent.value = '';
                    newFirstNameInput.value = '';
                    newLastNameInput.value = '';
                    newBtnCrearCuenta.classList.add(
                        'opacity-50',
                        'cursor-not-allowed',
                    );

                    //// CODIGO DE BIENVENIDA
                    hideElement('loginCreatePasswordNameDiv');
                    hideElement('btnBack');
                    showElement('bienvenidaDiv');

                    const firstNameWelcomeSpan = document.getElementById(
                        'firstNameWelcomeSpan',
                    ) as HTMLSpanElement;
                    firstNameWelcomeSpan.textContent = usuario?.firstName
                        ? usuario.firstName.split(' ')[0]
                        : '';

                    // Aquí puedes agregar la lógica para redirigir al usuario a la página principal o a donde desees
                    // window.location.href = '/';
                } else {
                    return;
                }
            } catch (error) {
                console.error('Error al crear la contraseña:', error);
            }
        });
    }

    // Configurar listeners en la carga inicial de la página
    setupCreatePasswordNameListeners();

    // Reconfigurar listeners después de las transiciones de vista de Astro
    document.addEventListener(
        'astro:page-load',
        setupCreatePasswordNameListeners,
    );
</script>
