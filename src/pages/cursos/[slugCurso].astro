---
import { clientGql } from '@graphql-astro/apolloClient';
import '@styles/global.css';
import { CursosDocument, ModulosPorCursoDocument, type Curso, type Modulo } from '@graphql-astro/generated/graphql';
import LayoutSeo from '@layouts/LayoutSeo.astro';
import { getCourseJsonLd } from 'src/utils/jsonld';
import { Icon } from 'astro-icon/components';

// Obtener el slug de los par√°metros de la URL
const { slugCurso } = Astro.params;

let cursos: Curso[] = [];
let curso: Curso | undefined;

// Realizar la consulta GraphQL para obtener los detalles del curso
try {
    const { data } = await clientGql.query({
        query: CursosDocument,
        variables: { offset: 0, limit: 1000 },
    });

    cursos = data?.Cursos || [];
    curso = cursos.find((c: Curso) => c.slug === slugCurso);
} catch (error) {
    console.error('Error fetching course details:', error);
    curso = undefined;
}

let modulos: Modulo[] = [];
if (curso && curso._id) {
    try {
        const { data: modulosData } = await clientGql.query({
            query: ModulosPorCursoDocument,
            variables: { cursoId: curso._id },
        });
        modulos = modulosData?.Modulo_findByCursoId || [];
    } catch (error) {
        console.error('Error fetching modules:', error);
    }
}

if (!curso) {
    return Astro.redirect('/404');
}

const {
    courseTitle,
    imagenURL,
    descripcionCorta,
    descripcionLarga,
    duracionHoras,
    precio,
    descuento,
    currency = 'USD',
    nivel,
    aprenderas,
    objetivos,
    dirigidoA,
    instructor,
    modulosIds,
    categorias,
    calificacionPromedio,
    numeroCalificaciones,
    _id,
    slug,
    urlVideo,
} = curso;

// Calcular precios
const currentPrice = precio || 0;
const originalPrice = descuento && descuento > 0 ? currentPrice / (1 - (descuento / 100)) : null;

// Formatter para moneda
const formatPrice = (amount: number) => {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: currency || 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(amount);
};

// Calcular total de unidades
const totalUnidades = modulos?.reduce((acc, modulo) => acc + (modulo.unidades?.length || 0), 0) || 0;

// Nivel en espa√±ol
const nivelTexto: Record<string, string> = {
    'Principiante': 'Principiante',
    'Intermedio': 'Intermedio',
    'Avanzado': 'Avanzado',
    'PRINCIPIANTE': 'Principiante',
    'INTERMEDIO': 'Intermedio',
    'AVANZADO': 'Avanzado',
};

const courseJsonLd = getCourseJsonLd(curso);
---

<LayoutSeo
    tituloPagina={courseTitle}
    description={descripcionCorta}
    slug={`cursos/${slug}`}
    image={imagenURL?.url}
    type="article"
    seoJsonLd={courseJsonLd}
    fluid={true}
    transparentNavbar={true}
>
    <!-- Secci√≥n Hero: Encabezado principal con imagen de fondo, t√≠tulo y resumen -->
    <section class="relative min-h-[500px] md:min-h-[600px] flex items-end overflow-hidden">
        <!-- Imagen de fondo con superposici√≥n oscura (Overlay) -->
        <div class="absolute inset-0">
            <img
                src={imagenURL?.url || '/placeholder-course.jpg'}
                alt={imagenURL?.alt || courseTitle}
                class="w-full h-full object-cover"
            />
            <div class="absolute inset-0 bg-gradient-to-t from-black/95 via-black/70 to-black/30"></div>
        </div>

        <!-- Hero Content -->
        <div class="relative z-10 w-full pb-16 pt-36">
            <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
                <div class="grid lg:grid-cols-3 gap-12 items-end">
                    <!-- Course Info -->
                    <div class="lg:col-span-2 text-white space-y-4">
                        <!-- Breadcrumb & Back -->
                        <nav class="flex items-center gap-2 text-sm text-white/70 mb-4">
                            <a href="/cursos" class="hover:text-white transition-colors">Cursos</a>
                            <span>/</span>
                            <span class="text-white/90 truncate max-w-xs">{courseTitle}</span>
                        </nav>

                        <!-- Badges -->
                        <div class="flex flex-wrap gap-2">
                            {categorias && categorias.length > 0 && (
                                <span class="px-3 py-1 rounded-full bg-primary/20 text-primary-content text-xs font-semibold border border-primary/30">
                                    {categorias[0].nombreCategoria}
                                </span>
                            )}
                            {nivel && (
                                <span class="px-3 py-1 rounded-full bg-secondary/20 text-secondary-content text-xs font-semibold border border-secondary/30">
                                    üìä {nivelTexto[nivel] || nivel}
                                </span>
                            )}
                            {descuento && descuento > 0 && (
                                <span class="px-3 py-1 rounded-full bg-red-500/90 text-white text-xs font-bold animate-pulse">
                                    üî• -{descuento}% OFF
                                </span>
                            )}
                        </div>

                        <!-- T√≠tulo del Curso -->
                        <h1 class="text-3xl md:text-4xl lg:text-5xl font-extrabold leading-tight">
                            {courseTitle}
                        </h1>

                        </h1>

                        <!-- Descripci√≥n Corta -->
                        <p class="text-lg text-white/80 max-w-2xl">
                            {descripcionCorta}
                        </p>

                        <!-- Fila de Estad√≠sticas: Calificaci√≥n, Duraci√≥n, M√≥dulos, Lecciones -->
                        <div class="flex flex-wrap items-center gap-6 pt-2">
                            {/* Calificaci√≥n (Estrellas) */}
                            {calificacionPromedio && calificacionPromedio > 0 && (
                                <div class="flex items-center gap-2">
                                    <div class="flex items-center gap-0.5 text-yellow-400">
                                        {[1, 2, 3, 4, 5].map((star) => (
                                            <svg
                                                class={`w-5 h-5 ${star <= Math.round(calificacionPromedio) ? 'fill-current' : 'fill-white/30'}`}
                                                viewBox="0 0 20 20"
                                            >
                                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                            </svg>
                                        ))}
                                    </div>
                                    <span class="font-bold text-yellow-400">{calificacionPromedio.toFixed(1)}</span>
                                    <span class="text-white/60 text-sm">({numeroCalificaciones} rese√±as)</span>
                                </div>
                            )}
                            
                            {/* Duration */}
                            {duracionHoras && (
                                <div class="flex items-center gap-2 text-white/80">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <span>{duracionHoras} horas</span>
                                </div>
                            )}

                            {/* Modules */}
                            {modulos && modulos.length > 0 && (
                                <div class="flex items-center gap-2 text-white/90 font-medium">
                                    <svg class="w-5 h-5 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                    </svg>
                                    <span>{modulos.length} m√≥dulos</span>
                                </div>
                            )}

                            {/* Units */}
                            {totalUnidades > 0 && (
                                <div class="flex items-center gap-2 text-white/80">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <span>{totalUnidades} lecciones</span>
                                </div>
                            )}
                        </div>

                        <!-- Informaci√≥n del Instructor (Mini perfil en el Hero) -->
                        {instructor && (
                            <div class="flex items-center gap-3 pt-4">
                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-primary to-secondary flex items-center justify-center text-white font-bold text-lg shadow-lg">
                                    {instructor.firstName?.charAt(0)}{instructor.lastName?.charAt(0)}
                                </div>
                                <div>
                                    <p class="font-semibold text-white">
                                        {instructor.firstName} {instructor.lastName}
                                    </p>
                                    <p class="text-sm text-white/60">{instructor.profesion}</p>
                                </div>
                            </div>
                        )}
                    </div>

                    <!-- Tarjeta de Precio (Visible solo en Desktop) -->
                    <div class="hidden lg:block">
                        <div class="bg-base-100 rounded-2xl shadow-2xl p-6 border border-base-200 space-y-4">
                            <!-- Precio y Descuento -->
                            <div class="text-center">
                                {originalPrice && (
                                    <p class="text-base-content/50 line-through text-lg">
                                        {formatPrice(originalPrice)}
                                    </p>
                                )}
                                <p class="text-4xl font-extrabold text-primary">
                                    {currentPrice === 0 ? 'GRATIS' : formatPrice(currentPrice)}
                                </p>
                                {descuento && descuento > 0 && (
                                    <p class="text-sm text-success font-semibold mt-1">
                                        ¬°Ahorras {formatPrice(originalPrice! - currentPrice)}!
                                    </p>
                                )}
                            </div>

                            <!-- Bot√≥n de Acci√≥n Principal (CTA) -->
                            <button class="btn btn-primary btn-lg w-full text-white font-bold text-lg shadow-lg shadow-primary/30 hover:shadow-xl hover:shadow-primary/40 hover:scale-[1.02] transition-all duration-300 rounded-xl">
                                üõí Comprar Ahora
                            </button>
                            
                            <!-- Bot√≥n Ver Trailer -->
                            {urlVideo ? (
                                <button onclick="document.getElementById('video_modal').showModal()" class="btn btn-outline btn-lg w-full font-bold text-lg border-2 hover:bg-base-content hover:text-base-100 hover:border-base-content transition-all duration-300 rounded-xl group">
                                    <span class="mr-2 group-hover:scale-110 transition-transform">üé•</span> Ver Trailer
                                </button>
                            ) : (
                                <div class="p-4 rounded-xl bg-base-200/50 border border-base-200 text-center">
                                    <p class="text-sm text-base-content/60 font-medium">‚ö†Ô∏è Este curso no tiene video promocional asignado.</p>
                                </div>
                            )}

                            <!-- Lista de Caracter√≠sticas Incluidas -->
                            <div class="space-y-3 pt-4 border-t border-base-200">
                                <p class="text-sm font-semibold text-base-content/80">Este curso incluye:</p>
                                <ul class="space-y-2 text-sm text-base-content/70">
                                    {duracionHoras && (
                                        <li class="flex items-center gap-2">
                                            <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            {duracionHoras} horas de contenido
                                        </li>
                                    )}
                                    {modulosIds && modulosIds.length > 0 && (
                                        <li class="flex items-center gap-2">
                                            <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                                            </svg>
                                            {modulosIds.length} m√≥dulos
                                        </li>
                                    )}
                                    {totalUnidades > 0 && (
                                        <li class="flex items-center gap-2">
                                            <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            {totalUnidades} lecciones
                                        </li>
                                    )}
                                    <li class="flex items-center gap-2">
                                        <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                                        </svg>
                                        Acceso de por vida
                                    </li>
                                    <li class="flex items-center gap-2">
                                        <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
                                        </svg>
                                        Certificado de finalizaci√≥n
                                    </li>
                                </ul>
                            </div>

                            <!-- Bot√≥n de Agregar a Favoritos -->
                            <button
                                id="btn-favorito"
                                class="btn btn-outline btn-sm w-full gap-2 rounded-xl"
                                data-id={_id}
                                data-coursetitle={courseTitle}
                                data-imagenURL={JSON.stringify(imagenURL)}
                                data-descripcioncorta={descripcionCorta}
                                data-slug={slug}
                            >
                                <Icon name="heart-line" id={`heart-line-${_id}`} class="w-5 h-5" />
                                <Icon name="heart-full" id={`heart-full-${_id}`} class="w-5 h-5 hidden text-red-500" />
                                Agregar a Favoritos
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Barra de Precio Fija (Solo M√≥vil - Sticky Bottom) -->
    <div class="lg:hidden fixed bottom-0 left-0 right-0 z-50 bg-base-100 border-t border-base-200 p-4 shadow-[0_-4px_30px_rgba(0,0,0,0.15)]">
        <div class="flex items-center justify-between gap-4">
            <div>
                {originalPrice && (
                    <p class="text-base-content/50 line-through text-sm">
                        {formatPrice(originalPrice)}
                    </p>
                )}
                <p class="text-2xl font-extrabold text-primary">
                    {currentPrice === 0 ? 'GRATIS' : formatPrice(currentPrice)}
                </p>
            </div>
            <button class="btn btn-primary flex-1 max-w-xs text-white font-bold shadow-lg shadow-primary/30 rounded-xl">
                üõí Comprar Ahora
            </button>
        </div>
    </div>

    <!-- Contenido Principal: Detalles profundos del curso -->
    <div class="bg-base-100 pb-32 lg:pb-16">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-12">
            <div class="grid lg:grid-cols-3 gap-12">
                <!-- Columna Izquierda: Secciones de informaci√≥n -->
                <div class="lg:col-span-2 space-y-12">
                    
                    <!-- Lo que Aprender√°s -->
                    {aprenderas && aprenderas.length > 0 && (
                        <section>
                            <h2 class="text-2xl font-bold text-base-content mb-6 flex items-center gap-3">
                                <span class="w-10 h-10 rounded-xl bg-primary/10 flex items-center justify-center">
                                    <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                                    </svg>
                                </span>
                                Lo que Aprender√°s
                            </h2>
                            <div class="bg-gradient-to-br from-primary/5 to-secondary/5 rounded-2xl p-8 border border-primary/10">
                                <ul class="grid sm:grid-cols-2 gap-x-6 gap-y-4">
                                    {aprenderas.map((item) => (
                                        <li class="flex items-start gap-3 text-base-content/80">
                                            <svg class="w-6 h-6 text-success flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            <span>{item}</span>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        </section>
                    )}

                    <!-- Descripci√≥n Larga -->
                    {descripcionLarga && (
                        <section>
                            <h2 class="text-2xl font-bold text-base-content mb-6 flex items-center gap-3">
                                <span class="w-10 h-10 rounded-xl bg-secondary/10 flex items-center justify-center">
                                    <svg class="w-6 h-6 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                </span>
                                Descripci√≥n del Curso
                            </h2>
                            <div class="prose prose-lg max-w-none text-base-content/80" set:html={descripcionLarga} />
                        </section>
                    )}

                    <!-- ¬øPara Qui√©n es Este Curso? -->
                    {dirigidoA && dirigidoA.length > 0 && (
                        <section>
                            <h2 class="text-2xl font-bold text-base-content mb-6 flex items-center gap-3">
                                <span class="w-10 h-10 rounded-xl bg-accent/10 flex items-center justify-center">
                                    <svg class="w-6 h-6 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                    </svg>
                                </span>
                                ¬øPara Qui√©n es Este Curso?
                            </h2>
                            <ul class="space-y-4">
                                {dirigidoA.map((item) => (
                                    <li class="flex items-start gap-3 text-base-content/80 bg-base-200/50 rounded-xl p-4 transition-all hover:shadow-sm hover:bg-base-200/80">
                                        <svg class="w-6 h-6 text-primary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                                        </svg>
                                        <span>{item}</span>
                                    </li>
                                ))}
                            </ul>
                        </section>
                    )}

                    <!-- Objetivos -->
                    {objetivos && objetivos.length > 0 && (
                        <section>
                            <h2 class="text-2xl font-bold text-base-content mb-6 flex items-center gap-3">
                                <span class="w-10 h-10 rounded-xl bg-success/10 flex items-center justify-center">
                                    <svg class="w-6 h-6 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                    </svg>
                                </span>
                                Objetivos del Curso
                            </h2>
                            <ul class="space-y-4">
                                {objetivos.map((objetivo, index) => (
                                    <li class="flex items-start gap-4 text-base-content/80 p-4 rounded-xl hover:bg-base-200/30 transition-colors">
                                        <span class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold text-sm flex-shrink-0">
                                            {index + 1}
                                        </span>
                                        <span class="pt-1">{objetivo}</span>
                                    </li>
                                ))}
                            </ul>
                        </section>
                    )}

                    <!-- Contenido del Curso -->
                    {modulos && modulos.length > 0 && (
                        <section>
                            <h2 class="text-2xl font-bold text-base-content mb-8 flex items-center gap-3">
                                <span class="w-12 h-12 rounded-xl bg-warning/10 flex items-center justify-center">
                                    <svg class="w-6 h-6 text-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                    </svg>
                                </span>
                                Contenido del Curso
                            </h2>
                            <p class="text-base-content/60 mb-8 pl-1">
                                {modulos.length} m√≥dulos ‚Ä¢ {totalUnidades} lecciones ‚Ä¢ {duracionHoras} horas de contenido
                            </p>
                            <div class="space-y-4">
                                {modulos.map((modulo: Modulo, index: number) => (
                                    <div class="collapse collapse-arrow bg-base-200/50 rounded-xl border border-base-200">
                                        <input type="checkbox" name="modulo-accordion" checked={index === 0} />
                                        <div class="collapse-title font-semibold text-base-content flex items-center gap-3">
                                            <span class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary text-sm font-bold">
                                                {modulo.numeroModulo}
                                            </span>
                                            {modulo.moduloTitle}
                                            <span class="ml-auto text-xs text-base-content/50 font-normal">
                                                {modulo.unidades?.length || 0} lecciones
                                            </span>
                                        </div>
                                        <div class="collapse-content">
                                            {modulo.descripcion && (
                                                <p class="text-sm text-base-content/60 mb-4">{modulo.descripcion}</p>
                                            )}
                                            {modulo.unidades && modulo.unidades.length > 0 && (
                                                <ul class="space-y-2">
                                                    {modulo.unidades.map((unidad) => (
                                                        <li class="flex items-center gap-3 text-sm text-base-content/70 py-2 px-3 rounded-lg hover:bg-base-300/50 transition-colors">
                                                            <svg class="w-5 h-5 text-primary/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                            </svg>
                                                            <span>{unidad.unidadTitle}</span>
                                                        </li>
                                                    ))}
                                                </ul>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </section>
                    )}

                    <!-- Sobre el Instructor -->
                    {instructor && (
                        <section>
                            <h2 class="text-2xl font-bold text-base-content mb-6 flex items-center gap-3">
                                <span class="w-10 h-10 rounded-xl bg-primary/10 flex items-center justify-center">
                                    <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 14l9-5-9-5-9 5 9 5z" />
                                        <path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222" />
                                    </svg>
                                </span>
                                Sobre el Instructor
                            </h2>
                            <div class="bg-gradient-to-br from-base-200/50 to-base-200/30 rounded-2xl p-8 border border-base-200">
                                <div class="flex flex-col sm:flex-row items-start gap-6">
                                    <div class="w-24 h-24 rounded-2xl bg-gradient-to-br from-primary to-secondary flex items-center justify-center text-white font-bold text-3xl shadow-xl flex-shrink-0">
                                        {instructor.firstName?.charAt(0)}{instructor.lastName?.charAt(0)}
                                    </div>
                                    <div class="space-y-3">
                                        <h3 class="text-xl font-bold text-base-content">
                                            {instructor.firstName} {instructor.lastName}
                                        </h3>
                                        {instructor.profesion && (
                                            <p class="text-base-content/70">{instructor.profesion}</p>
                                        )}
                                        {instructor.pais && (
                                            <p class="text-sm text-base-content/60 flex items-center gap-2">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                                </svg>
                                                {instructor.pais}
                                            </p>
                                        )}
                                        {instructor.especializacion && instructor.especializacion.length > 0 && (
                                            <div class="flex flex-wrap gap-2 pt-2">
                                                {instructor.especializacion.map((esp) => (
                                                    <span class="px-3 py-1 bg-primary/10 text-primary text-xs font-medium rounded-full">
                                                        {esp}
                                                    </span>
                                                ))}
                                            </div>
                                        )}
                                        {instructor.calificacionPromedio && instructor.calificacionPromedio > 0 && (
                                            <div class="flex items-center gap-2 pt-2">
                                                <div class="flex items-center gap-0.5 text-yellow-500">
                                                    {[1, 2, 3, 4, 5].map((star) => (
                                                        <svg 
                                                            class={`w-4 h-4 ${star <= Math.round(instructor.calificacionPromedio) ? 'fill-current' : ''}`}
                                                            fill={star <= Math.round(instructor.calificacionPromedio) ? 'currentColor' : 'none'}
                                                            stroke="currentColor"
                                                            viewBox="0 0 24 24"
                                                        >
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                                                        </svg>
                                                    ))}
                                                </div>
                                                <span class="text-sm text-base-content/70">
                                                    {instructor.calificacionPromedio.toFixed(1)} calificaci√≥n del instructor
                                                </span>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </section>
                    )}
                </div>

                <!-- Barra Lateral Pegajosa (Sticky Sidebar) - Visible solo en Desktop -->
                <div class="hidden lg:block">
                    <div class="sticky top-24 space-y-6">
                        <!-- Secci√≥n de Compartir en Redes Sociales -->
                        <div class="bg-base-100 rounded-2xl shadow-lg p-6 border border-base-200">
                            <h3 class="font-semibold text-base-content mb-4">Compartir este curso</h3>
                            <div class="flex gap-3">
                                <button class="btn btn-circle btn-outline btn-sm hover:bg-[#1877F2] hover:border-[#1877F2] hover:text-white tooltip" data-tip="Facebook">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                                </button>
                                <button class="btn btn-circle btn-outline btn-sm hover:bg-[#1DA1F2] hover:border-[#1DA1F2] hover:text-white tooltip" data-tip="Twitter">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>
                                </button>
                                <button class="btn btn-circle btn-outline btn-sm hover:bg-[#25D366] hover:border-[#25D366] hover:text-white tooltip" data-tip="WhatsApp">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                                </button>
                                <button class="btn btn-circle btn-outline btn-sm hover:bg-[#0A66C2] hover:border-[#0A66C2] hover:text-white tooltip" data-tip="LinkedIn">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
                                </button>
                                <button class="btn btn-circle btn-outline btn-sm tooltip" data-tip="Copiar enlace" onclick="navigator.clipboard.writeText(window.location.href)">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Informaci√≥n Adicional Resumida -->
                        <div class="bg-base-100 rounded-2xl shadow-lg p-6 border border-base-200">
                            <h3 class="font-semibold text-base-content mb-4">Informaci√≥n Adicional</h3>
                            <ul class="space-y-3 text-sm text-base-content/70">
                                <li class="flex justify-between">
                                    <span>Nivel</span>
                                    <span class="font-medium text-base-content">{nivelTexto[nivel || ''] || 'Todos los niveles'}</span>
                                </li>
                                <li class="flex justify-between">
                                    <span>Duraci√≥n</span>
                                    <span class="font-medium text-base-content">{duracionHoras || 'N/A'} horas</span>
                                </li>
                                <li class="flex justify-between">
                                    <span>Idioma</span>
                                    <span class="font-medium text-base-content">Espa√±ol</span>
                                </li>
                                <li class="flex justify-between">
                                    <span>Certificado</span>
                                    <span class="font-medium text-success">S√≠</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Secci√≥n CTA Final (Antes del Footer) -->
    <section class="bg-gradient-to-r from-primary to-secondary py-16">
        <div class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8 text-center text-white">
            <h2 class="text-3xl md:text-4xl font-extrabold mb-4">¬øListo para Empezar?</h2>
            <p class="text-lg text-white/80 mb-8 max-w-2xl mx-auto">
                √önete a miles de estudiantes que ya est√°n transformando sus carreras con este curso.
            </p>
            <div class="flex flex-col md:flex-row items-center justify-center gap-6 md:gap-8">
                <div class="flex items-baseline gap-3">
                    {originalPrice && (
                        <span class="text-white/60 line-through text-xl font-medium">
                            {formatPrice(originalPrice)}
                        </span>
                    )}
                    <span class="text-4xl md:text-5xl font-extrabold text-white tracking-tight">
                        {currentPrice === 0 ? 'GRATIS' : formatPrice(currentPrice)}
                    </span>
                </div>
                <button class="btn btn-lg bg-white text-primary hover:bg-white/90 border-0 font-bold text-lg shadow-xl hover:shadow-2xl hover:scale-[1.02] transition-all duration-300 rounded-xl px-10">
                    üõí Comprar Ahora
                </button>
            </div>
        </div>
    </section>

    <!-- Video Modal -->
    {urlVideo && (
        <dialog id="video_modal" class="modal backdrop-blur-md">
            <div class="modal-box w-11/12 max-w-5xl bg-black/90 text-white p-0 overflow-hidden relative shadow-2xl shadow-primary/20 border border-white/10 rounded-2xl">
                <form method="dialog">
                    <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2 z-50 text-white/70 hover:text-white hover:bg-white/20">‚úï</button>
                </form>
                <div class="aspect-video w-full">
                    {urlVideo.includes('youtube.com') || urlVideo.includes('youtu.be') ? (
                         <iframe 
                            width="100%" 
                            height="100%" 
                            src={`https://www.youtube.com/embed/${urlVideo.includes('v=') ? urlVideo.split('v=')[1].split('&')[0] : urlVideo.split('/').pop()?.split('?')[0]}`} 
                            title="YouTube video player" 
                            frameborder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                            allowfullscreen
                        ></iframe>
                    ) : (
                        <video controls class="w-full h-full">
                            <source src={urlVideo} type="video/mp4" />
                            Tu navegador no soporta el elemento de video.
                        </video>
                    )}
                </div>
            </div>
            <form method="dialog" class="modal-backdrop">
                <button>close</button>
            </form>
        </dialog>
    )}
</LayoutSeo>

<script>
    import { FAVORITOS_CURSOS } from '@const/const-string';
    import type { CursoFavorito } from 'src/interfaces/cursoFavorito.interface';

    // Maneja la l√≥gica de favoritos: guardar en localStorage y actualizar la UI
    function handleFavoritos() {
        const btnFavorito = document.getElementById('btn-favorito') as HTMLButtonElement;
        if (!btnFavorito) return;

        const _id = btnFavorito?.dataset.id ?? '';
        const courseTitle = btnFavorito?.dataset.coursetitle ?? '';
        const imagenURL = JSON.parse(btnFavorito?.dataset.imagenurl ?? '{}');
        const descripcionCorta = btnFavorito?.dataset.descripcioncorta ?? '';
        const slug = btnFavorito?.dataset.slug ?? '';

        const iconHeartFull = btnFavorito?.querySelector(`#heart-full-${_id}`) as HTMLElement;
        const iconHeartLine = btnFavorito?.querySelector(`#heart-line-${_id}`) as HTMLElement;

        let favoritosCursos: CursoFavorito[] = JSON.parse(
            localStorage.getItem(FAVORITOS_CURSOS) || '[]'
        );

        function toggleFavorito() {
            const isFavorito = favoritosCursos.some((favorito) => favorito._id == _id);
            if (isFavorito) {
                favoritosCursos = favoritosCursos.filter((favorito) => favorito._id !== _id);
            } else {
                favoritosCursos.push({
                    _id,
                    courseTitle,
                    imagenURL,
                    descripcionCorta,
                    slug,
                });
            }
            localStorage.setItem(FAVORITOS_CURSOS, JSON.stringify(favoritosCursos));
        }

        function handleheart() {
            const isFavorito = favoritosCursos.some((favorito) => favorito._id == _id);
            if (isFavorito) {
                iconHeartFull?.classList.remove('hidden');
                iconHeartLine?.classList.add('hidden');
            }
        }

        handleheart();

        btnFavorito?.addEventListener('click', () => {
            iconHeartFull?.classList.toggle('hidden');
            iconHeartLine?.classList.toggle('hidden');
            toggleFavorito();
        });
    }

    document.addEventListener('astro:page-load', handleFavoritos);
</script>
