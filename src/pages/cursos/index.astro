---
import { clientGql } from '@graphql-astro/apolloClient';
import { CursosDocument, CategoriasDocument, type Curso, type Categoria } from '@graphql-astro/generated/graphql';
import LayoutSeo from '@layouts/LayoutSeo.astro';
import { getCoursesJsonLd } from '@utils/jsonld';
import { CourseCatalog } from '@components/features/Courses/CourseCatalog';
import CoursesHero from '@components/sections/Courses/CoursesHero.astro';
import CoursesCategories from '@components/sections/Courses/CoursesCategories.astro';
import CoursesPopular from '@components/sections/Courses/CoursesPopular.astro';
import CoursesTestimonials from '@components/sections/Courses/CoursesTestimonials.astro';

export const prerender = true;

let cursos: Curso[] = [];
let categorias: Categoria[] = [];
let coursesJsonLd;
let hasMoreCourses = false;

    // Constante para la carga inicial de cursos
const INITIAL_COURSES_LIMIT = 24;

try {
    const [cursosResult, categoriasResult] = await Promise.all([
        clientGql.query({
            query: CursosDocument,
            variables: { offset: 0, limit: INITIAL_COURSES_LIMIT },
            fetchPolicy: 'no-cache'
        }),
        clientGql.query({
            query: CategoriasDocument,
        })
    ]);

    cursos = cursosResult.data?.Cursos || [];
    hasMoreCourses = cursos.length === INITIAL_COURSES_LIMIT;
    
    categorias = categoriasResult.data?.Categorias || [];
    
    // MOCK DATA: Inject categories if none found (for development/testing)
    if (categorias.length === 0) {
        categorias = [
            { _id: 'cat1', nombreCategoria: 'Mecánica', deleted: false, descripcion: 'Cursos de mecánica' },
            { _id: 'cat2', nombreCategoria: 'Procesos', deleted: false, descripcion: 'Ingeniería de procesos' },
            { _id: 'cat3', nombreCategoria: 'Seguridad', deleted: false, descripcion: 'Seguridad industrial' },
            { _id: 'cat4', nombreCategoria: 'Química', deleted: false, descripcion: 'Ingeniería química' },
        ];
    }

    coursesJsonLd = getCoursesJsonLd(cursos);
} catch (error) {
    console.error('Error fetching data for cursos index page:', error);
    cursos = [];
    categorias = [];
    coursesJsonLd = null;
}
---

<LayoutSeo tituloPagina="Cursos - IQ ENGI" seoJsonLd={coursesJsonLd} fluid={true}>
    <div class="antialiased">
        <CoursesHero />
        
        <CoursesCategories categorias={categorias} />
        
        <CoursesPopular cursos={cursos} />

        <div id="catalogo" class="bg-base-100 min-h-screen pt-4 pb-16">
             <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 mb-8 text-center md:text-left">
                <span class="text-xs font-bold tracking-widest text-primary uppercase">Catálogo Completo</span>
                <h2 class="text-3xl font-bold mt-2">Explora todos nuestros cursos</h2>
            </div>
            <CourseCatalog 
                client:idle 
                cursos={cursos} 
                categorias={categorias}
                hasMoreInitial={hasMoreCourses}
                initialLimit={INITIAL_COURSES_LIMIT}
            />
        </div>

        <CoursesTestimonials />
    </div>
</LayoutSeo>
