---
import Cards from '@components/molecules/Cards.astro';
import CursosFavoritosLista from '@components/sections/CursosFavoritosLista';
import { clientGql } from '@graphql-astro/apolloClient';
import { CursosDocument, type Curso } from '@graphql-astro/generated/graphql';
import LayoutSeo from '@layouts/LayoutSeo.astro';
import { getCoursesJsonLd } from '@utils/jsonld';
import { fade } from 'astro:transitions';

export const prerender = true;

let cursos: Curso[] = [];
let coursesJsonLd;

try {
    const { data } = await clientGql.query({
        query: CursosDocument,
        variables: { offset: 0, limit: 9 }, // Limit to 9 for carousel
    });

    cursos = data?.Cursos || [];
    coursesJsonLd = getCoursesJsonLd(cursos);
} catch (error) {
    console.error('Error fetching courses for favoritos page:', error);
    cursos = [];
    coursesJsonLd = null;
}
---

<LayoutSeo tituloPagina="Cursos Favoritos" description="Tus cursos guardados para ver más tarde en IQ ENGI" seoJsonLd={coursesJsonLd}>
    
    <div slot="Hero" class="text-center py-10" transition:animate={fade({ duration: '0.5s' })}>
        <h1 class="text-4xl lg:text-5xl font-extrabold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-primary to-secondary">
            Mis Cursos Favoritos
        </h1>
        <p class="text-lg text-base-content/80 max-w-2xl mx-auto">
            Accede rápidamente a los contenidos que más te interesan y continúa tu aprendizaje.
        </p>
    </div>

    <section class="min-h-[300px]" transition:animate="fade">
        <CursosFavoritosLista client:only="react" />
    </section>

    {cursos.length > 0 && (
        <section class="mt-20 pt-10 border-t border-base-200 mb-20 relative">
            <h2 class="text-3xl font-bold text-center mb-8">Te podría interesar</h2>
            
            <div class="relative group px-4 md:px-12">
                {/* Carousel container */}
                <div 
                    id="recommended-carousel"
                    class="flex overflow-x-auto snap-x snap-mandatory gap-6 pb-4 scrollbar-hide scroll-smooth"
                    style="scrollbar-width: none; -ms-overflow-style: none;"
                >
                    {cursos.map((curso) => (
                        <div class="snap-center shrink-0 w-full md:w-[calc(50%-12px)] lg:w-[calc(33.333%-16px)]">
                            <Cards {...curso} isBig={false} />
                        </div>
                    ))}
                </div>

                {/* Navigation Buttons */}
                <button 
                    id="prev-btn"
                    class="absolute left-0 top-1/2 -translate-y-1/2 z-10 btn btn-circle btn-primary shadow-lg opacity-0 group-hover:opacity-100 transition-opacity disabled:opacity-0"
                    aria-label="Anterior"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                    </svg>
                </button>
                <button 
                    id="next-btn"
                    class="absolute right-0 top-1/2 -translate-y-1/2 z-10 btn btn-circle btn-primary shadow-lg opacity-0 group-hover:opacity-100 transition-opacity disabled:opacity-0"
                    aria-label="Siguiente"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                    </svg>
                </button>
            </div>
        </section>
    )}
</LayoutSeo>

<script>
    function setupCarousel() {
        const container = document.getElementById('recommended-carousel');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        if (!container || !prevBtn || !nextBtn) return;

        const checkScroll = () => {
            if (!container) return;
            // Simple check to disable buttons if at ends (optional, removing disabled logic for infinite feel mostly)
            // But strict disable:
            // prevBtn.setAttribute('disabled', container.scrollLeft <= 0 ? 'true' : 'false');
            // nextBtn.setAttribute('disabled', container.scrollLeft + container.clientWidth >= container.scrollWidth - 1 ? 'true' : 'false');
        };

        const scroll = (direction: 'left' | 'right') => {
            const cardWidth = container.querySelector('div')?.clientWidth || 300;
            const gap = 24; // 1.5rem gap
            const scrollAmount = cardWidth + gap;
            
            if (direction === 'left') {
                container.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
            } else {
                container.scrollBy({ left: scrollAmount, behavior: 'smooth' });
            }
        };

        prevBtn.addEventListener('click', () => scroll('left'));
        nextBtn.addEventListener('click', () => scroll('right'));
        container.addEventListener('scroll', checkScroll);
        
        // Initial check
        checkScroll();
    }

    // Run on load and after View Transitions
    document.addEventListener('astro:page-load', setupCarousel);
</script>
