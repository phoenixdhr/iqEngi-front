---
import CourseCardStatic from '@components/molecules/Cards/CourseCardStatic.astro';
import CursosFavoritosLista from '@components/features/Courses/CursosFavoritosLista';
import { clientGql } from '@graphql-astro/apolloClient';
import { CursosDocument, type Curso } from '@graphql-astro/generated/graphql';
import LayoutSeo from '@layouts/LayoutSeo.astro';
import { getCoursesJsonLd } from '@utils/jsonld';
import { fade } from 'astro:transitions';

export const prerender = true;

let cursos: Curso[] = [];
let coursesJsonLd;

try {
    const { data } = await clientGql.query({
        query: CursosDocument,
        variables: { offset: 0, limit: 9 }, // Limit to 9 for carousel
    });

    cursos = data?.Cursos || [];
    coursesJsonLd = getCoursesJsonLd(cursos);
} catch (error) {
    console.error('Error fetching courses for favoritos page:', error);
    cursos = [];
    coursesJsonLd = null;
}
---

<LayoutSeo tituloPagina="Cursos Favoritos" description="Tus cursos guardados para ver más tarde en IQ ENGI" seoJsonLd={coursesJsonLd} fluid={true}>
    
    <!-- Hero Section -->
    <section class="relative pt-32 pb-20 overflow-hidden bg-base-100" transition:animate={fade({ duration: '0.5s' })}>
        <!-- Background Decorators -->
        <div class="absolute inset-0 overflow-hidden pointer-events-none">
            <div class="absolute top-0 inset-x-0 h-full bg-gradient-to-b from-base-200/50 to-transparent"></div>
            <div class="absolute -top-40 -left-40 w-[500px] h-[500px] bg-primary/10 rounded-full blur-[100px] opacity-70"></div>
            <div class="absolute top-20 -right-20 w-[400px] h-[400px] bg-secondary/10 rounded-full blur-[80px] opacity-70"></div>
        </div>

        <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <!-- Breadcrumb -->
            <nav class="flex justify-center items-center gap-2 text-sm text-base-content/60 mb-8" aria-label="Breadcrumb">
                <a href="/" class="hover:text-primary transition-colors duration-200">Inicio</a>
                <span class="text-base-content/30">/</span>
                <span class="font-medium text-base-content">Favoritos</span>
            </nav>

            <h1 class="text-4xl md:text-5xl lg:text-6xl font-extrabold mb-6 tracking-tight leading-tight">
                Tus Cursos <span class="text-transparent bg-clip-text bg-gradient-to-r from-primary to-secondary">Favoritos</span>
            </h1>
            
            <p class="text-lg md:text-xl text-base-content/70 max-w-2xl mx-auto leading-relaxed">
                Tus metas de aprendizaje, guardadas en un solo lugar. Organiza tu ruta de estudio y accede rápidamente al contenido que te inspira.
            </p>
        </div>
    </section>

    <!-- Main Content -->
    <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-32">
        <section class="min-h-[400px]" transition:animate="fade">
            <CursosFavoritosLista client:only="react" />
        </section>

        {cursos.length > 0 && (
            <section class="mt-24 pt-10 border-t border-base-200 relative">
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-bold mb-4">Te podría interesar</h2>
                    <p class="text-base-content/60 max-w-xl mx-auto">Explora otros cursos populares que podrían complementar tu aprendizaje.</p>
                </div>
                
                <div class="relative group px-4">
                    <!-- Carousel container -->
                    <div 
                        id="recommended-carousel"
                        class="flex overflow-x-auto snap-x snap-mandatory gap-6 pb-8 scrollbar-hide scroll-smooth"
                        style="scrollbar-width: none; -ms-overflow-style: none;"
                    >
                        {cursos.map((curso) => (
                            <div class="snap-center shrink-0 w-full sm:w-[calc(50%-12px)] lg:w-[calc(33.333%-16px)]">
                                <CourseCardStatic {...curso} />
                            </div>
                        ))}
                    </div>

                    <!-- Navigation Buttons (Hidden on mobile usually better UX, visible on hover desktop) -->
                    <div class="pointer-events-none absolute inset-0 flex items-center justify-between z-10 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        <button 
                            id="prev-btn"
                            class="pointer-events-auto ml-2 md:-ml-4 btn btn-circle btn-neutral shadow-lg border border-base-300 bg-base-100/80 backdrop-blur-sm hover:scale-110 transition-transform"
                            aria-label="Anterior"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                            </svg>
                        </button>
                        <button 
                            id="next-btn"
                            class="pointer-events-auto mr-2 md:-mr-4 btn btn-circle btn-neutral shadow-lg border border-base-300 bg-base-100/80 backdrop-blur-sm hover:scale-110 transition-transform"
                            aria-label="Siguiente"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                            </svg>
                        </button>
                    </div>
                </div>
            </section>
        )}
    </div>
</LayoutSeo>

<script>
    function setupCarousel() {
        const container = document.getElementById('recommended-carousel');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        if (!container || !prevBtn || !nextBtn) return;

        const scroll = (direction: 'left' | 'right') => {
            const cardElement = container.querySelector('div');
            const cardWidth = cardElement ? cardElement.clientWidth : 300;
            const gap = 24; // 1.5rem gap
            const scrollAmount = cardWidth + gap;
            
            if (direction === 'left') {
                container.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
            } else {
                container.scrollBy({ left: scrollAmount, behavior: 'smooth' });
            }
        };

        prevBtn.addEventListener('click', () => scroll('left'));
        nextBtn.addEventListener('click', () => scroll('right'));
    }

    // Run on load and after View Transitions
    document.addEventListener('astro:page-load', setupCarousel);
</script>
